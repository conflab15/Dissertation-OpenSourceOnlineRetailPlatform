@using OnlineRetailPlatformDiss.Models;
@using Microsoft.EntityFrameworkCore;
@using Microsoft.Extensions.Logging
@inject OnlineRetailPlatformDiss.Data.ApplicationDbContext _context;
@inject AuthenticationStateProvider auth;
@inject ILogger<ViewProducts> Logger
@attribute [Authorize]

<!-- This needs to be removed in the future to act as a component than an individual page -->
@page "/product/view"

<div class="container">
    <div class="row">
        <div class="col">
            <h1>View Business Products</h1>
        </div>
    </div>

    <!-- If there are no Businesses owned by the User, display this message: -->
    @if (businesses.Count == 0)
    {
        hasBusiness = false; //User has no businesses, preventing them 

        <div class="alert alert-danger" role="alert">
            <p>You must create a Business to be able to view its products</p>
            <button class="btn btn-primary">Create a Business</button> <!-- Button needs a route -->
        </div>
    }
    else
    {
        <!-- If there are businesses owned by the User, display this!-->
        <EditForm Model="@search">
            <div class="mb-3">
                <label for="businessName" class="form-label">Please select your business:</label>
                <InputSelect class="form-select" id="businessName" @bind-Value="search.BusinessNames" placeholder="20" enabled="@hasBusiness" @oninput="@GetProducts">
                <option value="">Select a Business...</option>
                @foreach (var business in businesses)
                    {
                        <option value="@business.BusinessName">@business.BusinessName</option>
                    }
                </InputSelect>
            </div>
        </EditForm>

        @if(search.BusinessNames == String.Empty)
        {
           <div class="alert alert-warning text-align-center" role="alert">
                <h2>Please select a business to view products to amend!</h2>
            </div>
        }
        else
        {
            @if (businessProducts != null)
            {
              <table class="table">
              <thead>
                <tr>
                  <th scope="col">Product Name</th>
                  <th scope="col">Product Description</th>
                  <th scope="col">Options</th>
                </tr>
              </thead>
              <tbody>
                  @foreach (var product in businessProducts) //This doesn't operate, products appear then quickly disappear...
                    {
                        <tr>
                            <th>@product.ProductName</th>
                            <th>@product.ProductDescription</th>
                            <th>Manage Business</th>
                        </tr>
                    }
              </tbody>
              </table>
            }
            else
            {
                <div class="alert alert-warning" role="alert">
                    <p>We couldn't find any products for your business!</p>
                    <button class="btn btn-alert">Create a Product</button>
                </div>
            }
        }
    }

</div>


@code {

    private List<BusinessAccountModel>? businesses; //List of Users businesses
    private List<ProductModel>? businessProducts; //List of Businesses products.
    private string? manager; //Manager of the business (User.Identity.Name)
    public bool hasBusiness = true; //User has a business unless otherwise declared
    private string? BusinessName;//Empty string to assign a business name too. 

    private class SearchModel 
    {
        public string? BusinessNames;
    }
    private SearchModel search = new SearchModel(); //Search Model to obtain a string of the business name from the Select DropDown form

    protected override void OnInitialized()
    {
        BusinessName = String.Empty;
        manager = auth.GetAuthenticationStateAsync().Result.User.Identity.Name; //Finding the active users email address.
        businesses = _context.BusinessAccount.Where(x => x.ManagerID == manager).ToList(); //Finding the businesses of the active user to select from. 
    }

    private async void GetProducts()
    {
        var x = BusinessName;

        //Finding all products owned by the business, adding them to the businessProducts list.
        businessProducts = await _context.Products.Where(x => x.BusinessName == search.BusinessNames).ToListAsync();

        //Change the state of the page to refresh the page and populate the list...
        base.StateHasChanged();
    }
}